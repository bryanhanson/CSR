{
  "hash": "a9dbc6a0509e49ef1606639b3208d822",
  "result": {
    "markdown": "---\ntitle: \"Metabolic Phenotyping Protocol Part 3\"\ndescription: \"Implementing the Statistical Analysis in Metabolic Phenotyping Protocol of Blaise *et al.*\"\ndate: \"2022-04-29\"\ncategories: [R, ChemoSpec, Metabolomics, PLS]\nbibliography:\n  - REFS.bib\n  - grateful-refs.bib\n---\n\n::: {.cell}\n\n:::\n\n* Part 1 of this series is [here](https://chemospec.org/posts/2022-02-01-Protocol-Pt1/).\n* Part 2 of this series is [here](https://chemospec.org/posts/2022-03-24-Protocol-Pt2/).\n\nIf you aren't familiar with `ChemoSpec`, you might wish to look at the introductory [vignette](https://bryanhanson.github.io/ChemoSpec/articles/ChemoSpec.html) first.\n\n*In this series of posts we are following the protocol as described in the printed publication closely [@Blaise2021].  The authors have also provided a [Jupyter notebook](https://github.com/Gscorreia89/chemometrics-tutorials).  This is well worth your time, even if Python is not your preferred lanaguage, as there are additional examples and discussion for study.*\n\n# Read in the Data\n\nLoad the `Spectra` object we created in Part 2 so we can summarize it.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(\"ChemoSpec\")\nload(\"Worms2.RData\")  # restores the 'Worms2' Spectra object\nsumSpectra(Worms2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n C. elegans metabolic phenotyping study (Blaise 2007) \n\n\tThere are 133 spectra in this set.\n\tThe y-axis unit is intensity.\n\n\tThe frequency scale runs from\n\t8.9995 to 5e-04 ppm\n\tThere are 8600 frequency values.\n\tThe frequency resolution is\n\t0.001 ppm/point.\n\n\tThis data set is not continuous\n\talong the frequency axis.\n\tHere are the data chunks:\n\n  beg.freq end.freq   size beg.indx end.indx\n1   8.9995   5.0005 -3.999        1     4000\n2   4.5995   0.0005 -4.599     4001     8600\n\n\tThe spectra are divided into 4 groups: \n\n   group no.     color symbol alt.sym\n1 Mut_L2  28 #FB0D16FF      0      m2\n2 Mut_L4  33 #FFC0CBFF     15      m4\n3  WT_L2  32 #511CFCFF      1      w2\n4  WT_L4  40 #2E94E9FF     16      w4\n\n\n*** Note: this is an S3 object\nof class 'Spectra'\n```\n:::\n:::\n\n# Exploratory Data Analysis, Con't.\n\nIf you recall in Part 2 we removed five samples.  Let's re-run PCA without these samples and show the key plots.  We will simply report these here without much discussion; they are pretty much as expected.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nc_pca <- c_pcaSpectra(Worms2, choice = \"autoscale\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplotScree(c_pca)\n```\n\n::: {.cell-output-display}\n![Scree plot (recommended style).](2022-04-29-Protocol-Pt3_files/figure-html/fig-screeAlt-1.png){#fig-screeAlt fig-align='center' width=80%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np <- plotScores(Worms2, c_pca, pcs = 1:2, ellipse = \"rob\", tol = 0.02)\np\n```\n\n::: {.cell-output-display}\n![Score plot for PCs 1 and 2. Compare to protocol figure 7d.](2022-04-29-Protocol-Pt3_files/figure-html/fig-scores12-1.png){#fig-scores12 fig-align='center' width=80%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np <- plotScores(Worms2, c_pca, pcs = 2:3, ellipse = \"rob\", leg.loc = \"topright\",\n    tol = 0.02)\np\n```\n\n::: {.cell-output-display}\n![Score plot for PCS 2 and 3.](2022-04-29-Protocol-Pt3_files/figure-html/fig-scores23-1.png){#fig-scores23 fig-align='center' width=80%}\n:::\n:::\n\nOne thing the published protocol does not explicitly discuss is an inspection of the loadings, but it is covered in the [Jupyter notebook](https://github.com/Gscorreia89/chemometrics-tutorials).  The loadings are useful in order to see if any particular frequencies are driving the separation of the samples in the score plot. Let's plot the loadings (@fig-loadings). Remember that these data were autoscaled, and hence all frequencies, including noisy frequencies, will contribute to the separation.  If we had not scaled the data, these plots would look dramatically different.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np <- plotLoadings(Worms2, c_pca, loads = 1:2)\np\n```\n\n::: {.cell-output-display}\n![Loadings for PC1 and PC2.](2022-04-29-Protocol-Pt3_files/figure-html/fig-loadings-1.png){#fig-loadings fig-align='center' width=80%}\n:::\n:::\n\nThe s-plot is another very useful way to find peaks that are important in separating the samples (@fig-splot); we can see that the peaks around $\\delta$ 1.30 - 1.32, 1.47-1.48, and 3.03 - 3.07 are important drivers of the separation in the score plot.  Having discovered this, one can investigate the source of those peaks.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np <- sPlotSpectra(Worms2, c_pca, tol = 0.001)\np\n```\n\n::: {.cell-output-display}\n![s-Plot for PC1.](2022-04-29-Protocol-Pt3_files/figure-html/fig-splot-1.png){#fig-splot fig-align='center' width=80%}\n:::\n:::\n\n## Supervised Analysis with PLS-DA\n\n`ChemoSpec` carries out exploratory data analysis, which is an unsupervised process.  The next step in the protocol is PLS-DA (partial least squares - discriminant analysis). I have written about `ChemoSpec` + PLS [here](https://chemospec.org/posts/2021-02-08-PLS/2021-02-08-PLS.html) if you would like more background on plain PLS. However, PLS-DA is a technique that combines data reduction/variable selection along with classification. We'll need the `mixOmics` package (@mixOmics) package for this analysis; note that loading it replaces the `plotLoadings` function from `ChemoSpec`.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(\"mixOmics\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: MASS\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: lattice\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nLoaded mixOmics 6.20.0\nThank you for using mixOmics!\nTutorials: http://mixomics.org\nBookdown vignette: https://mixomicsteam.github.io/Bookdown\nQuestions, issues: Follow the prompts at http://mixomics.org/contact-us\nCite us:  citation('mixOmics')\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'mixOmics'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:ChemoSpec':\n\n    plotLoadings\n```\n:::\n:::\n\n@fig-plsda-indiv shows the score plot; the results suggest that classification and modeling may be successful.  The `splsda` function carries out a single *sparse* computation. One computation should not be considered the ideal answer; a better approach is to use cross-validation, for instance the `bootsPLS` function in the `bootsPLS` package (@bootsPLS which uses `splsda` under the hood).  However, that computation is too time-consuming to demonstrate here.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nX <- Worms2$data\nY <- Worms2$groups\nsplsda <- splsda(X, Y, ncomp = 8)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplotIndiv(splsda, col.per.group = c(\"#FB0D16FF\", \"#FFC0CBFF\", \"#511CFCFF\", \"#2E94E9FF\"),\n    title = \"sPLS-DA Score Plot\", legend = TRUE, ellipse = TRUE)\n```\n\n::: {.cell-output-display}\n![sPLS-DA plot showing classification.](2022-04-29-Protocol-Pt3_files/figure-html/fig-plsda-indiv-1.png){#fig-plsda-indiv fig-align='center' width=80%}\n:::\n:::\n\nTo estimate the number of components needed, the `perf` function can be used. The results are in @fig-plsda-perf and suggest that five components are sufficient to describe the data.\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nperf.splsda <- perf(splsda, folds = 5, nrepeat = 5)\nplot(perf.splsda)\n```\n\n::: {.cell-output-display}\n![Evaluation of the PLS-DA performance.](2022-04-29-Protocol-Pt3_files/figure-html/fig-plsda-perf-1.png){#fig-plsda-perf fig-align='center' width=80%}\n:::\n:::\n\nAt this point, we have (several) ideas of how to proceed.  Going forward, one might choose to focus on accurate classification, or on determining which frequencies should be included in a predictive model.  Any model will need to refined and more details extracted.  The reader is referred to the case study from the [mixOmics](http://mixomics.org/case-studies/splsda-srbct/) folks which covers these tasks and explains the process.\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n---\n\nThis post was created using `ChemoSpec` version 6.1.3 and `ChemoSpecUtils` version 1.0.0.",
    "supporting": [
      "2022-04-29-Protocol-Pt3_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}