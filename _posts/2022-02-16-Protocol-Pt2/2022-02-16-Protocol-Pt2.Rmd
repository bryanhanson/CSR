---
title: "Metabolic Phenotyping Protocol Part 2"
description: Implementing the Statistical Analysis in Metabolic Phenotyping Protocol of Blaise *et al.*
author: "Bryan Hanson"
date: 2022-02-16
categories:
  - R
  - ChemoSpec
output:
  distill::distill_article:
    self_contained: false
bibliography: REFS.bib
draft: true
---

```{r SetUp, echo = FALSE, eval = TRUE, results = "hide", warning = FALSE, message = FALSE}

# R options & configuration:
set.seed(9)
rm(list = ls())
suppressPackageStartupMessages(library("ChemoSpec"))
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("knitr"))

descCS <- packageDescription("ChemoSpec")
descCSU <- packageDescription("ChemoSpecUtils")

options(ChemoSpecGraphics = "ggplot2")

# Stuff specifically for knitr:

# Hook for figure size control
knitr::opts_hooks$set(sq.fig = function(options) {

  if (isFALSE(options$sq.fig)) {
    # custom fig dimensions given, use w/o further delay
    if ((!is.null(options$fig.width)) & (!is.null(options$fig.height))) return(options)
    # otherwise set the default wide aspect ratio
    if ((is.null(options$fig.width)) & (is.null(options$fig.height))) {
      options$fig.width = 6
      options$fig.height = 3.5
    }
  }

  if (isTRUE(options$sq.fig)) {
    options$fig.width = 5
    options$fig.height = 5
  }
  options
})

# choices here are designed to work with the hook
knitr::opts_chunk$set(fig.align = "center", sq.fig = FALSE, tidy = TRUE,
  fig.width = NULL, fig.height = NULL, out.width = "80%", cache = TRUE)
```

Part 1 of this series is [here](https://chemospec.org/posts/2022-02-01-Protocol-Pt1/).

If you aren't familiar with `ChemoSpec`, you might wish to look at the introductory [vignette](https://bryanhanson.github.io/ChemoSpec/articles/ChemoSpec.html) first.

# Read in the Data

I saved the `Spectra` object we collected in Part 1 so we can read it and remind ourselves of what's in it. Due to the compression in R's `save` function the data takes up 4.9 Mb on disk; it was originally about 30 Mb.

```{r getData}
library("ChemoSpec")
load("Worms.Rdata") # restores the "Worms" Spectra object
sumSpectra(Worms)
```

# Exploratory Data Analysis

We will follow the steps described in the protocol closely.

## Normalization & Scaling

Use PQN normalization; scaling in `ChemoSpec` is applied at the PCA stage (next).

```{r norm}
Worms <- normSpectra(Worms) # PQN is the default
```

## PCA

Conduct classical PCA without scaling.[^1]  Note that `ChemoSpec` includes several different variants of PCA, with scaling options.  See the introductory vignette for more details.  For more about what PCA is and how it works, please see the [LearnPCA](https://bryanhanson.github.io/LearnPCA/) package.

```{r pca}
c_pca <- c_pcaSpectra(Worms) # no scaling is the default
```

### Components to Retain

A key question at this stage is how many components are needed to describe the data set.  Keep in mind that this depends on the choice of scaling.  Figures \@ref(fig:screeAlt) and \@ref(fig:screeTrad) are two different types of scree plots, which give the residual variance.  This is the R^2^~x~ value in the protocol (see protocol Figure 7a).  Another approach to answering this question is to do a cross-validated PCA.  The results are shown in Figure \@ref(fig:cv-pca).  These are the Q^2^~x~ values in protocol Figure 7a.  All of these ways of looking at the variance explained suggest that retaining three or possibly four PCs is adequate.

```{r screeAlt, fig.cap = "Scree plot (recommended style)."}
plotScree(c_pca)
```

```{r screeTrad, fig.cap = "Scree plot (traditional style)."}
plotScree(c_pca, style = "trad")
```

```{r cv-pca, sq.fig = TRUE}
cv_pcaSpectra(Worms, pcs = 6)
```

### Score Plots

Next, examine the score plots (Figures \@ref(fig:scores12), \@ref(fig:scores23)).  In these plots, each data point is colored by its group membership (keep in mind this has nothing to do with the PCA calculation).  In addition, robust confidence ellipses are shown for each group.  Inspection of these ellipses is one way to identify potential outliers.  Note that the protocol recommends plotting Hotelling's *T*^2^ ellipse for the entire data set; this is not implemented in `ChemoSpec` (see the Appendix for how to draw it).

Inspection of these plots shows that the age of the worms (L2 vs L4) has more of an effect than than the genotype (WT vs Mut). In Figure \@ref(fig:scores12) we don't really see any serious outlier candiates.  However, in Figure \@ref(fig:scores23) we do see some candidates, especially for the L2 group along PC3 (two samples in particular; in the protocol they remove five samples).

```{r scores12, sq.fig = TRUE, fig.cap = "Score plot for PCs 1 and 2."}
p <- plotScores(Worms, c_pca, pcs = 1:2, ellipse = "rob")
p
```

```{r scores23, sq.fig = TRUE, fig.cap = "Score plot for PCS 2 and 3."}
p <- plotScores(Worms, c_pca, pcs = 2:3, ellipse = "rob", leg.loc = list(x = 0.85, y = 0.3), tol = 0.02)
p
```

To label more sample points, you can increase the value of the argument `tol`.

### Outliers

Another way to identify outliers is to use the approach described in @Filzmoser2009 section 3.7.3.  Figures \@ref(fig:diagOD) and  \@ref(fig:diagSD) give the plots. Please see Filzmoser for the details, but any samples that are above the plotted threshold line are candidate outliers, and any samples above the threshold in *both* plots should be looked at very carefully.  Though we are using classical PCA, Filzmoser recommends using these plots with robust PCA.  These plots are a better approach than "eye balling it".

```{r diagOD, sq.fig = TRUE, fig.cap = "Orthogonal distance plot based on the first three PCs."}
p <- pcaDiag(Worms, c_pca, plot = "OD")
p <- p + coord_cartesian(ylim = c(0.0475, 0.0530))
p
```

```{r diagSD, sq.fig = TRUE, fig.cap = "Score distance plot based on the first three PCs."}
p <- pcaDiag(Worms, c_pca, plot = "SD")
p
```

Analysis of these plots suggest that samples 1, 37, 40, 101 and 107 are likely outliers.  They can be removed as follows.

```{r removeOutliers}
Worms <- removeSample(Worms,
  rem.sam = c("1_", "37_", "40_", "101_", "107_"))
```

At this point one should probably repeat the PCA, score plots and diagnostic plots to get a good look at how removing these samples affected things, but to save space those tasks are left to the reader.

One thing the protocol does not explicitly discuss is an inspection of the loadings.  This is useful in order to see if any particular frequencies are driving the separation of the samples in the score plot. For the sake of completeness, we'll go ahead and plot the loadings. See Figure \@ref(fig:loadings). From this plot it is clear that the peaks above $\delta$ 5.0 are not contributing much to differentiating the samples.  One could consider removing these peaks from the analysis, but we'll leave them for now.

```{r loadings, sq.fig = TRUE, fig.cap = "Loadings for PC1 and PC2."}
p <- plotLoadings(Worms, c_pca, loads = 1:2)
p
```

# Appendix: Adding Hotelling's *T*^2^ Ellipse

If you really want Hotellings *T*^2^ it is not hard to do, via the `HotellingEllipse` package.

```{r hotelling1}
library("HotellingEllipse")
xy_coord <- ellipseCoord(c_pca$x),
  pcx = 1, pcy = 2,
  conf.limit = 0.95, pts = 500)
p <- plotScores(Worms, c_pca, which = 1:2, ellipse = "none")
```

---

This post was created using `ChemoSpec` version `r descCS$Version` and `ChemoSpecUtils` version `r descCSU$Version`.

[^1]: Without scaling, the largest peaks will drive the separation in the scores plot.
